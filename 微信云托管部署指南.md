# 微信云托管部署指南

## 项目概述
本项目是一个基于 Spring Boot 2.7.17 的用户中心管理系统，提供用户注册、登录、信息管理等功能。

## 一、准备工作

### 1.1 项目已完成的配置
- ✅ Dockerfile（多阶段构建）
- ✅ .dockerignore（排除不必要文件）
- ✅ application-prod.properties（生产环境配置）
- ✅ Spring Boot Actuator（健康检查）

### 1.2 需要准备的信息
- 微信云托管账号
- 代码托管仓库（Git）
- MySQL 数据库实例

## 二、微信云托管部署步骤

### 2.1 创建 MySQL 数据库实例

1. 登录微信云托管控制台
2. 进入「云数据库」-「MySQL」
3. 创建新实例：
   - 数据库版本：MySQL 8.0
   - 实例规格：根据需求选择
   - 数据库名称：yupi（或自定义）

4. 导入数据库表结构：
   ```bash
   # 使用项目中的 SQL 文件
   mysql -h <数据库地址> -u <用户名> -p <数据库名> < SQL语句/create_table.sql
   ```

### 2.2 推送代码到 Git 仓库

```bash
# 添加所有新文件
git add Dockerfile .dockerignore src/main/resources/application-prod.properties pom.xml

# 提交更改
git commit -m "配置微信云托管部署环境"

# 推送到远程仓库
git push origin master
```

### 2.3 在微信云托管创建服务

1. **进入云托管控制台**
   - 进入「云托管」-「服务管理」
   - 点击「新建服务」

2. **配置服务基本信息**
   - 服务名称：TagMate_backed
   - 代码来源：选择你的 Git 仓库
   - 分支：master（或你的主分支）

3. **配置构建参数**
   - 构建方式：Dockerfile
   - Dockerfile 路径：`./Dockerfile`
   - 构建目录：`/`

4. **配置运行参数**
   - 端口：8081
   - 实例规格：根据需求选择（建议至少 1 核 1GB）
   - 副本数：1（可根据负载调整）

### 2.4 配置环境变量

在「服务配置」-「环境变量」中添加以下变量：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `DB_HOST` | 数据库地址 | `rm-xxxxx.mysql.rds.aliyuncs.com` |
| `DB_PORT` | 数据库端口 | `3306` |
| `DB_NAME` | 数据库名称 | `yupi` |
| `DB_USER` | 数据库用户名 | `root` |
| `DB_PASSWORD` | 数据库密码 | `your_password` |
| `KNIFE4J_ENABLE` | 是否启用 API 文档 | `false`（生产环境建议关闭） |

**注意**：数据库密码等敏感信息请妥善保管，不要提交到代码仓库。

### 2.5 触发部署

1. 点击「部署」按钮
2. 等待构建和部署完成（首次构建可能需要 5-10 分钟）
3. 查看部署日志确认是否成功

## 三、验证部署

### 3.1 健康检查
访问健康检查端点确认服务运行正常：
```
https://<你的云托管域名>/actuator/health
```

预期返回：
```json
{
  "status": "UP"
}
```

### 3.2 测试 API 接口

使用 Postman 或 curl 测试接口：

**注册接口**
```bash
curl -X POST https://<你的云托管域名>/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "userAccount": "testuser",
    "userPassword": "12345678",
    "checkPassword": "12345678"
  }'
```

**登录接口**
```bash
curl -X POST https://<你的云托管域名>/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "userAccount": "testuser",
    "userPassword": "12345678"
  }'
```

### 3.3 查看日志
在微信云托管控制台：
- 进入「日志」查看应用运行日志
- 检查是否有错误或异常信息

## 四、常见问题排查

### 4.1 数据库连接失败
- 检查环境变量配置是否正确
- 确认数据库实例是否允许云托管服务访问（白名单/安全组）
- 验证数据库用户名密码

### 4.2 容器启动失败
- 查看构建日志，确认 Maven 构建是否成功
- 检查 Dockerfile 配置
- 确认端口配置是否正确

### 4.3 接口访问 404
- 确认服务已成功启动
- 检查请求路径是否正确
- 查看应用日志

## 五、性能优化建议

### 5.1 数据库连接池
已在 `application-prod.properties` 中配置 HikariCP 连接池：
- 最小空闲连接：5
- 最大连接数：20
- 根据实际负载调整

### 5.2 日志配置
生产环境已关闭 MyBatis SQL 日志输出，减少日志量

### 5.3 监控告警
- 配置微信云托管监控告警
- 关注 CPU、内存、数据库连接数等指标
- 设置健康检查失败告警

## 六、安全建议

### 6.1 API 文档
生产环境已默认关闭 Knife4j API 文档（`knife4j.enable=false`）

### 6.2 数据库安全
- 使用强密码
- 定期备份数据库
- 限制数据库访问来源

### 6.3 HTTPS
- 微信云托管默认提供 HTTPS 支持
- 确保所有敏感接口使用 HTTPS 访问

## 七、扩容说明

当业务量增长时，可以通过以下方式扩容：
1. **垂直扩容**：增加单个实例的 CPU 和内存
2. **水平扩容**：增加实例副本数（需要配置 Session 共享）

**注意**：当前使用内存 Session，多实例部署时 Session 不共享。如需多实例，建议：
- 使用 Spring Session + Redis
- 或改用 JWT 无状态认证

## 八、联系支持

如遇到问题：
1. 查看微信云托管官方文档
2. 检查项目日志和错误信息
3. 联系微信云托管技术支持

---

**部署检查清单**

- [ ] 数据库实例已创建并导入表结构
- [ ] 代码已推送到 Git 仓库
- [ ] 环境变量已正确配置
- [ ] 服务构建成功
- [ ] 健康检查端点返回正常
- [ ] API 接口测试通过
- [ ] 日志输出正常
- [ ] 监控告警已配置
